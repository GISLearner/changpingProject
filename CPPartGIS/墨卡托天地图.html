<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>²ýÆ½ÇøÓòÍ¼·ùºÅ</title>



<link rel="stylesheet" href="css/main.css">

		<script>
			var dojoConfig = {
				mblAlwaysHideAddressBar: true
				};
    </script>
    <link rel="stylesheet" href="http://39.105.40.172/jsapi324/3.24compact/esri/css/esri.css">
    <script src="http://39.105.40.172/jsapi324/3.24compact/init.js"></script>
<script>
  require([
    "esri/map",
    "esri/layers/ArcGISDynamicMapServiceLayer",
    "esri/geometry/Point", 
    "dojox/mobile",
    "dojox/mobile/parser",
    "esri/sniff",
    "dojox/mobile/deviceTheme",
    "dojo/dom",
    "dijit/registry",
    "dojo/on",
    "dojox/mobile/ToolBarButton",
    "dojox/mobile/View",
    "dojox/mobile/ContentPane",
    "dojo/domReady!"
  ],

    function (Map, ArcGISDynamicMapServiceLayer, Point,
        mobile, parser, has, dTheme, dom, registry, on) {
      parser.parse();
      mobile.hideAddressBar();
      initLayer();
      var options = { logo: false };
      var map = new esri.Map("map",
          options
          );
      var p = new Point(116.16, 40.26);
      map.centerAndZoom(p,10);

      var tf = new esri.layers.ArcGISDynamicMapServiceLayer(
                          "http://39.105.40.172:6080/arcgis/rest/services/CPparks_WGS84/MapServer");
     




      map.on("load", mapLoadHandler);

      var resizeEvt = (window.onorientationchange !== undefined && !has('android')) ? "orientationchange" : "resize";

      on(window, resizeEvt, resizeMap);
      //map.addLayer(new WebTileLayer());
     map.addLayer(new WebTileLayer("t"));
      map.addLayer(tf);
        



      function mapLoadHandler(evt) {
        resizeMap();
        registry.byId('mapView').on('AfterTransitionIn', resizeMap);
      }

      function resizeMap() {
        mobile.hideAddressBar();
        adjustMapHeight();
        map.resize();
        map.reposition();
      }

      function adjustMapHeight() {
        var availHeight = mobile.getScreenSize().h - registry.byId('header').domNode.clientHeight - 1;
        if (has('iphone') || has('ipod')) {
          availHeight += iphoneAdjustment();
        }
        dom.byId("map").style.height = availHeight + "px";
      }

      function iphoneAdjustment() {
        var sz = mobile.getScreenSize();
        if (sz.h > sz.w) { 
          return screen.availHeight - window.innerHeight - 40;
        }
        else { 
          var _conn = on(window, 'resize', function () {
            _conn.remove();
            resizeMap();
          });
          return 0;
        }
      }

      function initLayer() {
          dojo.declare("WebTileLayer", esri.layers.TiledMapServiceLayer, {
              _type: "",
              constructor: function (type) {
                  this._type = type;
                  this.spatialReference = new esri.SpatialReference({ wkid: 3857 });
                  this.initialExtent = (this.fullExtent =
                      new esri.geometry.Extent(-20037508.342787, -20037508.342787, 20037508.342787, 20037508.342787,
                      this.spatialReference));


                  this.tileInfo = new esri.layers.TileInfo({
                      "rows": 256,
                      "cols": 256,
                      "compressionQuality": 0,
                      "origin": {
                          "x": -20037508.342787 ,
                          "y": 20037508.342787
//
 //		"x": -20037508.342787 - 755,
//                          "y": 20037508.342787 - 230


                      },
                      "spatialReference": {
                          "wkid": 3857
                      },

                      "lods": [
                          { "level": 0, "resolution": 156543.033928, "scale": 591657527.591555 },
                          { "level": 1, "resolution": 78271.5169639999, "scale": 295828763.795777 },
                          { "level": 2, "resolution": 39135.7584820001, "scale": 147914381.897889 },
                          { "level": 3, "resolution": 19567.8792409999, "scale": 73957190.948944 },
                          { "level": 4, "resolution": 9783.93962049996, "scale": 36978595.474472 },
                          { "level": 5, "resolution": 4891.96981024998, "scale": 18489297.737236 },
                          { "level": 6, "resolution": 2445.98490512499, "scale": 9244648.868618 },
                          { "level": 7, "resolution": 1222.99245256249, "scale": 4622324.434309 },
                          { "level": 8, "resolution": 611.49622628138, "scale": 2311162.217155 },
                          { "level": 9, "resolution": 305.748113140558, "scale": 1155581.108577 },
                          { "level": 10, "resolution": 152.874056570411, "scale": 577790.554289 },
                          { "level": 11, "resolution": 76.4370282850732, "scale": 288895.277144 },
                          { "level": 12, "resolution": 38.2185141425366, "scale": 144447.638572 },
                          { "level": 13, "resolution": 19.1092570712683, "scale": 72223.819286 },
                          { "level": 14, "resolution": 9.55462853563415, "scale": 36111.909643 },
                          { "level": 15, "resolution": 4.77731426794937, "scale": 18055.954822 },
                          { "level": 16, "resolution": 2.38865713397468, "scale": 9027.977411 },
                          { "level": 17, "resolution": 1.19432856685505, "scale": 4513.988705 },
                          { "level": 18, "resolution": 0.597164283559817, "scale": 2256.994353 },
                          { "level": 19, "resolution": 0.298582141647617, "scale": 1128.497176 }
                      ]
                  });

                  this.loaded = true;
                  this.onLoad(this);
              },

              getTileUrl: function (level, row, col) {
                  if (this._type == null)
                      return 'http://webst0' + (col % 4 + 1) + '.is.autonavi.com/appmaptile?tk=96d757dfaf417c8a032b36e81db1b79c&style=6&x=' + col + '&y=' + row + '&z=' + level;
                  else if (this._type == "t")
                     return 'http://t' + (col % 7) + '.tianditu.cn/img_w/wmts?tk=96d757dfaf417c8a032b36e81db1b79c&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILECOL=' + col + '&TILEROW=' + row + '&TILEMATRIX=' + level;
     }
          });
      }

    });
</script>
</head>

<body>
  <div id="mapView" data-dojo-type="dojox.mobile.View" data-dojo-props="selected: true">
    <div id="header" data-dojo-type="dojox.mobile.Heading">
      <div id="aboutButton" data-dojo-type="dojox.mobile.ToolBarButton" style="float: right;" moveTo="aboutView">
        About
      </div>
    </div>
    <div id="mapContainer" data-dojo-type="dojox.mobile.ContentPane">
      <div id="map"></div>
    </div>
  </div>

  <div id="aboutView" data-dojo-type="dojox.mobile.View">
    <h1 data-dojo-type="dojox.mobile.Heading" data-dojo-props="back:'Map', moveTo:'mapView'">About</h1>

    <p style="padding: 5px;">This page created by YangQin.</p>
	<!--<p style="padding: 5px;">I don't know what to write here,change when I know in the furture.</p>-->


  </div>
</body>
</html>
